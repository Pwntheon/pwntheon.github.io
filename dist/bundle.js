!function(t){var e={};function n(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)n.d(i,r,function(e){return t[e]}.bind(null,r));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="dist",n(n.s=8)}([function(t,e,n){"use strict";const i=2.3283064365386963e-10;class r{constructor(){this._seed=0,this._s0=0,this._s1=0,this._s2=0,this._c=0}getSeed(){return this._seed}setSeed(t){return t=t<1?1/t:t,this._seed=t,this._s0=(t>>>0)*i,t=69069*t+1>>>0,this._s1=t*i,t=69069*t+1>>>0,this._s2=t*i,this._c=1,this}getUniform(){let t=2091639*this._s0+this._c*i;return this._s0=this._s1,this._s1=this._s2,this._c=0|t,this._s2=t-this._c,this._s2}getUniformInt(t,e){let n=Math.max(t,e),i=Math.min(t,e);return Math.floor(this.getUniform()*(n-i+1))+i}getNormal(t=0,e=1){let n,i,r;do{n=2*this.getUniform()-1,i=2*this.getUniform()-1,r=n*n+i*i}while(r>1||0==r);return t+n*Math.sqrt(-2*Math.log(r)/r)*e}getPercentage(){return 1+Math.floor(100*this.getUniform())}getItem(t){return t.length?t[Math.floor(this.getUniform()*t.length)]:null}shuffle(t){let e=[],n=t.slice();for(;n.length;){let t=n.indexOf(this.getItem(n));e.push(n.splice(t,1)[0])}return e}getWeightedValue(t){let e=0;for(let n in t)e+=t[n];let n,i=this.getUniform()*e,r=0;for(n in t)if(r+=t[n],i<r)return n;return n}getState(){return[this._s0,this._s1,this._s2,this._c]}setState(t){return this._s0=t[0],this._s1=t[1],this._s2=t[2],this._c=t[3],this}clone(){return(new r).setState(this.getState())}}e.a=(new r).setSeed(Date.now())},function(t,e,n){"use strict";function i(t,e){return(t%e+e)%e}function r(t,e=0,n=1){return t<e?e:t>n?n:t}function o(t){return t.charAt(0).toUpperCase()+t.substring(1)}function s(t,...e){let n=s.map;return t.replace(/%(?:([a-z]+)|(?:{([^}]+)}))/gi,(function(i,r,s,a){if("%"==t.charAt(a-1))return i.substring(1);if(!e.length)return i;let l=e[0],c=(r||s).split(","),h=c.shift()||"",u=n[h.toLowerCase()];if(!u)return i;l=e.shift();let f=l[u].apply(l,c),p=h.charAt(0);return p!=p.toLowerCase()&&(f=o(f)),f}))}n.r(e),n.d(e,"mod",(function(){return i})),n.d(e,"clamp",(function(){return r})),n.d(e,"capitalize",(function(){return o})),n.d(e,"format",(function(){return s})),s.map={s:"toString"}},function(t,e,n){"use strict";n.r(e),n.d(e,"fromString",(function(){return o})),n.d(e,"add",(function(){return s})),n.d(e,"add_",(function(){return a})),n.d(e,"multiply",(function(){return l})),n.d(e,"multiply_",(function(){return c})),n.d(e,"interpolate",(function(){return h})),n.d(e,"lerp",(function(){return u})),n.d(e,"interpolateHSL",(function(){return f})),n.d(e,"lerpHSL",(function(){return p})),n.d(e,"randomize",(function(){return _})),n.d(e,"rgb2hsl",(function(){return g})),n.d(e,"hsl2rgb",(function(){return y})),n.d(e,"toRGB",(function(){return m})),n.d(e,"toHex",(function(){return b}));var i=n(1),r=n(0);function o(t){let e,n;if(t in v)e=v[t];else{if("#"==t.charAt(0)){let n=(t.match(/[0-9a-f]/gi)||[]).map(t=>parseInt(t,16));if(3==n.length)e=n.map(t=>17*t);else{for(let t=0;t<3;t++)n[t+1]+=16*n[t],n.splice(t,1);e=n}}else e=(n=t.match(/rgb\(([0-9, ]+)\)/i))?n[1].split(/\s*,\s*/).map(t=>parseInt(t)):[0,0,0];v[t]=e}return e.slice()}function s(t,...e){let n=t.slice();for(let t=0;t<3;t++)for(let i=0;i<e.length;i++)n[t]+=e[i][t];return n}function a(t,...e){for(let n=0;n<3;n++)for(let i=0;i<e.length;i++)t[n]+=e[i][n];return t}function l(t,...e){let n=t.slice();for(let t=0;t<3;t++){for(let i=0;i<e.length;i++)n[t]*=e[i][t]/255;n[t]=Math.round(n[t])}return n}function c(t,...e){for(let n=0;n<3;n++){for(let i=0;i<e.length;i++)t[n]*=e[i][n]/255;t[n]=Math.round(t[n])}return t}function h(t,e,n=.5){let i=t.slice();for(let r=0;r<3;r++)i[r]=Math.round(i[r]+n*(e[r]-t[r]));return i}const u=h;function f(t,e,n=.5){let i=g(t),r=g(e);for(let t=0;t<3;t++)i[t]+=n*(r[t]-i[t]);return y(i)}const p=f;function _(t,e){e instanceof Array||(e=Math.round(r.a.getNormal(0,e)));let n=t.slice();for(let t=0;t<3;t++)n[t]+=e instanceof Array?Math.round(r.a.getNormal(0,e[t])):e;return n}function g(t){let e,n=t[0]/255,i=t[1]/255,r=t[2]/255,o=Math.max(n,i,r),s=Math.min(n,i,r),a=0,l=(o+s)/2;if(o==s)e=0;else{let t=o-s;switch(e=l>.5?t/(2-o-s):t/(o+s),o){case n:a=(i-r)/t+(i<r?6:0);break;case i:a=(r-n)/t+2;break;case r:a=(n-i)/t+4}a/=6}return[a,e,l]}function d(t,e,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?t+6*(e-t)*n:n<.5?e:n<2/3?t+(e-t)*(2/3-n)*6:t}function y(t){let e=t[2];if(0==t[1])return e=Math.round(255*e),[e,e,e];{let n=t[1],i=e<.5?e*(1+n):e+n-e*n,r=2*e-i,o=d(r,i,t[0]+1/3),s=d(r,i,t[0]),a=d(r,i,t[0]-1/3);return[Math.round(255*o),Math.round(255*s),Math.round(255*a)]}}function m(t){return`rgb(${t.map(t=>Object(i.clamp)(t,0,255)).join(",")})`}function b(t){return`#${t.map(t=>Object(i.clamp)(t,0,255).toString(16).padStart(2,"0")).join("")}`}const v={black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]}},function(t){t.exports=JSON.parse('{"a":{"rotConfig":{"width":80,"height":45,"font-size":18,"forceSquareRatio":true},"playArea":{"width":80,"height":40}},"b":{"width":150,"height":80,"levels":["Cave","Cave","Cave"]},"c":{"cave":{"iterations":3,"fill":0.5}}}')},function(t,e,n){"use strict";n.d(e,"a",(function(){return i}));class i{getContainer(){return null}setOptions(t){this._options=t}}},function(t,e,n){"use strict";(function(t){n.d(e,"a",(function(){return s}));var i=n(4),r=n(2);function o(t){let e=r.fromString(t);return 36*Math.floor(e[0]*(6/256))+6*Math.floor(e[1]*(6/256))+1*Math.floor(e[2]*(6/256))+16}class s extends i.a{constructor(){super(),this._offset=[0,0],this._cursor=[-1,-1],this._lastColor=""}schedule(t){setTimeout(t,1e3/60)}setOptions(t){super.setOptions(t);let e=[t.width,t.height],n=this.computeSize();this._offset=n.map((t,n)=>Math.floor((t-e[n])/2))}clear(){t.stdout.write(`[0;48;5;${o(this._options.bg)}m[2J`)}draw(e,n){let[i,r,s,a,l]=e,c=this._offset[0]+i,h=this._offset[1]+r,u=this.computeSize();if(c<0||c>=u[0])return;if(h<0||h>=u[1])return;if(c===this._cursor[0]&&h===this._cursor[1]||(t.stdout.write(function(t,e){return`[${e+1};${t+1}H`}(c,h)),this._cursor[0]=c,this._cursor[1]=h),n&&(s||(s=" ")),!s)return;let f=function(t,e){return`[0;38;5;${o(t)};48;5;${o(e)}m`}(a,l);f!==this._lastColor&&(t.stdout.write(f),this._lastColor=f);let p=[].concat(s);t.stdout.write(p[0]),this._cursor[0]++,this._cursor[0]>=u[0]&&(this._cursor[0]=0,this._cursor[1]++)}computeFontSize(){throw new Error("Terminal backend has no notion of font size")}eventToPosition(t,e){return[t,e]}computeSize(){return[t.stdout.columns,t.stdout.rows]}}}).call(this,n(7))},function(t){t.exports=JSON.parse('{"Player":{"name":"Player","components":[{"name":"Glyph","character":"@","foreground":"white","background":"black"},"WalkMovable","EventListener","Sight","PlayerActor",{"name":"Attacker","attack":10},{"name":"Destructible","maxHp":40}]},"Newt":{"name":"Newt","components":[{"name":"Glyph","character":":","foreground":"yellow","background":"black"},"WanderActor","WalkMovable","Destructible",{"name":"Attacker","attack":1},{"name":"Destructible","maxHp":8}]},"Bat":{"name":"Bat","components":[{"name":"Glyph","character":"B","foreground":"lightgray","background":"black"},"WanderActor","WalkMovable","Destructible",{"name":"Attacker","attack":3},{"name":"Destructible","maxHp":10}]},"Fungus":{"name":"Fungus","components":[{"name":"Glyph","character":"F","foreground":"lime","background":"black"},"FungusActor","Destructible"]}}')},function(t,e){var n,i,r=t.exports={};function o(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function a(t){if(n===setTimeout)return setTimeout(t,0);if((n===o||!n)&&setTimeout)return n=setTimeout,setTimeout(t,0);try{return n(t,0)}catch(e){try{return n.call(null,t,0)}catch(e){return n.call(this,t,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:o}catch(t){n=o}try{i="function"==typeof clearTimeout?clearTimeout:s}catch(t){i=s}}();var l,c=[],h=!1,u=-1;function f(){h&&l&&(h=!1,l.length?c=l.concat(c):u=-1,c.length&&p())}function p(){if(!h){var t=a(f);h=!0;for(var e=c.length;e;){for(l=c,c=[];++u<e;)l&&l[u].run();u=-1,e=c.length}l=null,h=!1,function(t){if(i===clearTimeout)return clearTimeout(t);if((i===s||!i)&&clearTimeout)return i=clearTimeout,clearTimeout(t);try{i(t)}catch(e){try{return i.call(null,t)}catch(e){return i.call(this,t)}}}(t)}}function _(t,e){this.fun=t,this.array=e}function g(){}r.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)e[n-1]=arguments[n];c.push(new _(t,e)),1!==c.length||h||a(p)},_.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=g,r.addListener=g,r.once=g,r.off=g,r.removeListener=g,r.removeAllListeners=g,r.emit=g,r.prependListener=g,r.prependOnceListener=g,r.listeners=function(t){return[]},r.binding=function(t){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(t){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},function(t,e,n){"use strict";n.r(e);var i={};n.r(i),n.d(i,"TYPE_TEXT",(function(){return O})),n.d(i,"TYPE_NEWLINE",(function(){return P})),n.d(i,"TYPE_FG",(function(){return k})),n.d(i,"TYPE_BG",(function(){return E})),n.d(i,"measure",(function(){return S})),n.d(i,"tokenize",(function(){return T}));var r={};n.r(r),n.d(r,"Glyph",(function(){return Rt})),n.d(r,"Destructible",(function(){return Re})),n.d(r,"Attacker",(function(){return Fe})),n.d(r,"EventListener",(function(){return Qe})),n.d(r,"Sight",(function(){return ln})),n.d(r,"WalkMovable",(function(){return Gt})),n.d(r,"PlayerActor",(function(){return ne})),n.d(r,"FungusActor",(function(){return fe})),n.d(r,"WanderActor",(function(){return Oe}));var o={};n.r(o),n.d(o,"Cave",(function(){return Pn}));var s=n(0),a=n(4);class l extends a.a{constructor(){super(),this._ctx=document.createElement("canvas").getContext("2d")}schedule(t){requestAnimationFrame(t)}getContainer(){return this._ctx.canvas}setOptions(t){super.setOptions(t);const e=`${t.fontStyle?`${t.fontStyle} `:""} ${t.fontSize}px ${t.fontFamily}`;this._ctx.font=e,this._updateSize(),this._ctx.font=e,this._ctx.textAlign="center",this._ctx.textBaseline="middle"}clear(){this._ctx.fillStyle=this._options.bg,this._ctx.fillRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height)}eventToPosition(t,e){let n=this._ctx.canvas,i=n.getBoundingClientRect();return t-=i.left,e-=i.top,t*=n.width/i.width,e*=n.height/i.height,t<0||e<0||t>=n.width||e>=n.height?[-1,-1]:this._normalizedEventToPosition(t,e)}}var c=n(1);class h extends l{constructor(){super(),this._spacingX=0,this._spacingY=0,this._hexSize=0}draw(t,e){let[n,i,r,o,s]=t,a=[(n+1)*this._spacingX,i*this._spacingY+this._hexSize];if(this._options.transpose&&a.reverse(),e&&(this._ctx.fillStyle=s,this._fill(a[0],a[1])),!r)return;this._ctx.fillStyle=o;let l=[].concat(r);for(let t=0;t<l.length;t++)this._ctx.fillText(l[t],a[0],Math.ceil(a[1]))}computeSize(t,e){return this._options.transpose&&(t+=e,t-=e=t-e),[Math.floor(t/this._spacingX)-1,Math.floor((e-2*this._hexSize)/this._spacingY+1)]}computeFontSize(t,e){this._options.transpose&&(t+=e,t-=e=t-e);let n=2*t/((this._options.width+1)*Math.sqrt(3))-1,i=e/(2+1.5*(this._options.height-1)),r=Math.min(n,i),o=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let s=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=o;let a=s/100;r=Math.floor(r)+1;let l=2*r/(this._options.spacing*(1+a/Math.sqrt(3)));return Math.ceil(l)-1}_normalizedEventToPosition(t,e){let n;this._options.transpose?(t+=e,t-=e=t-e,n=this._ctx.canvas.width):n=this._ctx.canvas.height;let i=n/this._options.height;return e=Math.floor(e/i),Object(c.mod)(e,2)?(t-=this._spacingX,t=1+2*Math.floor(t/(2*this._spacingX))):t=2*Math.floor(t/(2*this._spacingX)),[t,e]}_fill(t,e){let n=this._hexSize,i=this._options.border;const r=this._ctx;r.beginPath(),this._options.transpose?(r.moveTo(t-n+i,e),r.lineTo(t-n/2+i,e+this._spacingX-i),r.lineTo(t+n/2-i,e+this._spacingX-i),r.lineTo(t+n-i,e),r.lineTo(t+n/2-i,e-this._spacingX+i),r.lineTo(t-n/2+i,e-this._spacingX+i),r.lineTo(t-n+i,e)):(r.moveTo(t,e-n+i),r.lineTo(t+this._spacingX-i,e-n/2+i),r.lineTo(t+this._spacingX-i,e+n/2-i),r.lineTo(t,e+n-i),r.lineTo(t-this._spacingX+i,e+n/2-i),r.lineTo(t-this._spacingX+i,e-n/2+i),r.lineTo(t,e-n+i)),r.fill()}_updateSize(){const t=this._options,e=Math.ceil(this._ctx.measureText("W").width);let n,i;this._hexSize=Math.floor(t.spacing*(t.fontSize+e/Math.sqrt(3))/2),this._spacingX=this._hexSize*Math.sqrt(3)/2,this._spacingY=1.5*this._hexSize,t.transpose?(n="height",i="width"):(n="width",i="height"),this._ctx.canvas[n]=Math.ceil((t.width+1)*this._spacingX),this._ctx.canvas[i]=Math.ceil((t.height-1)*this._spacingY+2*this._hexSize)}}class u extends l{constructor(){super(),this._spacingX=0,this._spacingY=0,this._canvasCache={}}setOptions(t){super.setOptions(t),this._canvasCache={}}draw(t,e){u.cache?this._drawWithCache(t):this._drawNoCache(t,e)}_drawWithCache(t){let e,[n,i,r,o,s]=t,a=""+r+o+s;if(a in this._canvasCache)e=this._canvasCache[a];else{let t=this._options.border;e=document.createElement("canvas");let n=e.getContext("2d");if(e.width=this._spacingX,e.height=this._spacingY,n.fillStyle=s,n.fillRect(t,t,e.width-t,e.height-t),r){n.fillStyle=o,n.font=this._ctx.font,n.textAlign="center",n.textBaseline="middle";let t=[].concat(r);for(let e=0;e<t.length;e++)n.fillText(t[e],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[a]=e}this._ctx.drawImage(e,n*this._spacingX,i*this._spacingY)}_drawNoCache(t,e){let[n,i,r,o,s]=t;if(e){let t=this._options.border;this._ctx.fillStyle=s,this._ctx.fillRect(n*this._spacingX+t,i*this._spacingY+t,this._spacingX-t,this._spacingY-t)}if(!r)return;this._ctx.fillStyle=o;let a=[].concat(r);for(let t=0;t<a.length;t++)this._ctx.fillText(a[t],(n+.5)*this._spacingX,Math.ceil((i+.5)*this._spacingY))}computeSize(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]}computeFontSize(t,e){let n=Math.floor(t/this._options.width),i=Math.floor(e/this._options.height),r=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let o=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=r;let s=o/100*i/n;return s>1&&(i=Math.floor(i/s)),Math.floor(i/this._options.spacing)}_normalizedEventToPosition(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]}_updateSize(){const t=this._options,e=Math.ceil(this._ctx.measureText("W").width);this._spacingX=Math.ceil(t.spacing*e),this._spacingY=Math.ceil(t.spacing*t.fontSize),t.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._ctx.canvas.width=t.width*this._spacingX,this._ctx.canvas.height=t.height*this._spacingY}}u.cache=!1;class f extends l{constructor(){super(),this._colorCanvas=document.createElement("canvas")}draw(t,e){let[n,i,r,o,s]=t,a=this._options.tileWidth,l=this._options.tileHeight;if(e&&(this._options.tileColorize?this._ctx.clearRect(n*a,i*l,a,l):(this._ctx.fillStyle=s,this._ctx.fillRect(n*a,i*l,a,l))),!r)return;let c=[].concat(r),h=[].concat(o),u=[].concat(s);for(let t=0;t<c.length;t++){let e=this._options.tileMap[c[t]];if(!e)throw new Error(`Char "${c[t]}" not found in tileMap`);if(this._options.tileColorize){let r=this._colorCanvas,o=r.getContext("2d");o.globalCompositeOperation="source-over",o.clearRect(0,0,a,l);let s=h[t],c=u[t];o.drawImage(this._options.tileSet,e[0],e[1],a,l,0,0,a,l),"transparent"!=s&&(o.fillStyle=s,o.globalCompositeOperation="source-atop",o.fillRect(0,0,a,l)),"transparent"!=c&&(o.fillStyle=c,o.globalCompositeOperation="destination-over",o.fillRect(0,0,a,l)),this._ctx.drawImage(r,n*a,i*l,a,l)}else this._ctx.drawImage(this._options.tileSet,e[0],e[1],a,l,n*a,i*l,a,l)}}computeSize(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}computeFontSize(){throw new Error("Tile backend does not understand font size")}_normalizedEventToPosition(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}_updateSize(){const t=this._options;this._ctx.canvas.width=t.width*t.tileWidth,this._ctx.canvas.height=t.height*t.tileHeight,this._colorCanvas.width=t.tileWidth,this._colorCanvas.height=t.tileHeight}}var p=n(2);class _ extends a.a{static isSupported(){return!!document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0})}constructor(){super(),this._uniforms={};try{this._gl=this._initWebGL()}catch(t){alert(t.message)}}schedule(t){requestAnimationFrame(t)}getContainer(){return this._gl.canvas}setOptions(t){super.setOptions(t),this._updateSize();let e=this._options.tileSet;e&&"complete"in e&&!e.complete?e.addEventListener("load",()=>this._updateTexture(e)):this._updateTexture(e)}draw(t,e){const n=this._gl,i=this._options;let[r,o,s,a,l]=t,c=n.canvas.height-(o+1)*i.tileHeight;if(n.scissor(r*i.tileWidth,c,i.tileWidth,i.tileHeight),e&&(i.tileColorize?n.clearColor(0,0,0,0):n.clearColor(...b(l)),n.clear(n.COLOR_BUFFER_BIT)),!s)return;let h=[].concat(s),u=[].concat(l),f=[].concat(a);n.uniform2fv(this._uniforms.targetPosRel,[r,o]);for(let t=0;t<h.length;t++){let e=this._options.tileMap[h[t]];if(!e)throw new Error(`Char "${h[t]}" not found in tileMap`);n.uniform1f(this._uniforms.colorize,i.tileColorize?1:0),n.uniform2fv(this._uniforms.tilesetPosAbs,e),i.tileColorize&&(n.uniform4fv(this._uniforms.tint,b(f[t])),n.uniform4fv(this._uniforms.bg,b(u[t]))),n.drawArrays(n.TRIANGLE_STRIP,0,4)}}clear(){const t=this._gl;t.clearColor(...b(this._options.bg)),t.scissor(0,0,t.canvas.width,t.canvas.height),t.clear(t.COLOR_BUFFER_BIT)}computeSize(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}computeFontSize(){throw new Error("Tile backend does not understand font size")}eventToPosition(t,e){let n=this._gl.canvas,i=n.getBoundingClientRect();return t-=i.left,e-=i.top,t*=n.width/i.width,e*=n.height/i.height,t<0||e<0||t>=n.width||e>=n.height?[-1,-1]:this._normalizedEventToPosition(t,e)}_initWebGL(){let t=document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0});window.gl=t;let e=function(t,e,n){const i=t.createShader(t.VERTEX_SHADER);if(t.shaderSource(i,e),t.compileShader(i),!t.getShaderParameter(i,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(i)||"");const r=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(r,n),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(r)||"");const o=t.createProgram();if(t.attachShader(o,i),t.attachShader(o,r),t.linkProgram(o),!t.getProgramParameter(o,t.LINK_STATUS))throw new Error(t.getProgramInfoLog(o)||"");return o}(t,d,y);return t.useProgram(e),function(t){const e=new Float32Array([0,0,1,0,0,1,1,1]),n=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),t.enableVertexAttribArray(0),t.vertexAttribPointer(0,2,t.FLOAT,!1,0,0)}(t),g.forEach(n=>this._uniforms[n]=t.getUniformLocation(e,n)),this._program=e,t.enable(t.BLEND),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.enable(t.SCISSOR_TEST),t}_normalizedEventToPosition(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}_updateSize(){const t=this._gl,e=this._options,n=[e.width*e.tileWidth,e.height*e.tileHeight];t.canvas.width=n[0],t.canvas.height=n[1],t.viewport(0,0,n[0],n[1]),t.uniform2fv(this._uniforms.tileSize,[e.tileWidth,e.tileHeight]),t.uniform2fv(this._uniforms.targetSize,n)}_updateTexture(t){!function(t,e){let n=t.createTexture();t.bindTexture(t.TEXTURE_2D,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,0),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e)}(this._gl,t)}}const g=["targetPosRel","tilesetPosAbs","tileSize","targetSize","colorize","bg","tint"],d="\n#version 300 es\n\nin vec2 tilePosRel;\nout vec2 tilesetPosPx;\n\nuniform vec2 tilesetPosAbs;\nuniform vec2 tileSize;\nuniform vec2 targetSize;\nuniform vec2 targetPosRel;\n\nvoid main() {\n\tvec2 targetPosPx = (targetPosRel + tilePosRel) * tileSize;\n\tvec2 targetPosNdc = ((targetPosPx / targetSize)-0.5)*2.0;\n\ttargetPosNdc.y *= -1.0;\n\n\tgl_Position = vec4(targetPosNdc, 0.0, 1.0);\n\ttilesetPosPx = tilesetPosAbs + tilePosRel * tileSize;\n}".trim(),y="\n#version 300 es\nprecision highp float;\n\nin vec2 tilesetPosPx;\nout vec4 fragColor;\nuniform sampler2D image;\nuniform bool colorize;\nuniform vec4 bg;\nuniform vec4 tint;\n\nvoid main() {\n\tfragColor = vec4(0, 0, 0, 1);\n\n\tvec4 texel = texelFetch(image, ivec2(tilesetPosPx), 0);\n\n\tif (colorize) {\n\t\ttexel.rgb = tint.a * tint.rgb + (1.0-tint.a) * texel.rgb;\n\t\tfragColor.rgb = texel.a*texel.rgb + (1.0-texel.a)*bg.rgb;\n\t\tfragColor.a = texel.a + (1.0-texel.a)*bg.a;\n\t} else {\n\t\tfragColor = texel;\n\t}\n}".trim();let m={};function b(t){if(!(t in m)){let e;if("transparent"==t)e=[0,0,0,0];else if(t.indexOf("rgba")>-1){e=(t.match(/[\d.]+/g)||[]).map(Number);for(let t=0;t<3;t++)e[t]=e[t]/255}else e=p.fromString(t).map(t=>t/255),e.push(1);m[t]=e}return m[t]}var v=n(5);const w=/%([bc]){([^}]*)}/g,O=0,P=1,k=2,E=3;function S(t,e){let n={width:0,height:1},i=T(t,e),r=0;for(let t=0;t<i.length;t++){let e=i[t];switch(e.type){case O:r+=e.value.length;break;case P:n.height++,n.width=Math.max(n.width,r),r=0}}return n.width=Math.max(n.width,r),n}function T(t,e){let n=[],i=0;t.replace(w,(function(e,r,o,s){let a=t.substring(i,s);return a.length&&n.push({type:O,value:a}),n.push({type:"c"==r?k:E,value:o.trim()}),i=s+e.length,""}));let r=t.substring(i);return r.length&&n.push({type:O,value:r}),function(t,e){e||(e=1/0);let n=0,i=0,r=-1;for(;n<t.length;){let o=t[n];if(o.type==P&&(i=0,r=-1),o.type!=O){n++;continue}for(;0==i&&" "==o.value.charAt(0);)o.value=o.value.substring(1);let s=o.value.indexOf("\n");if(-1!=s){o.value=x(t,n,s,!0);let e=o.value.split("");for(;e.length&&" "==e[e.length-1];)e.pop();o.value=e.join("")}if(o.value.length){if(i+o.value.length>e){let s=-1;for(;;){let t=o.value.indexOf(" ",s+1);if(-1==t)break;if(i+t>e)break;s=t}if(-1!=s)o.value=x(t,n,s,!0);else if(-1!=r){let e=t[r],i=e.value.lastIndexOf(" ");e.value=x(t,r,i,!0),n=r}else o.value=x(t,n,e-i,!1)}else i+=o.value.length,-1!=o.value.indexOf(" ")&&(r=n);n++}else t.splice(n,1)}t.push({type:P});let o=null;for(let e=0;e<t.length;e++){let n=t[e];switch(n.type){case O:o=n;break;case P:if(o){let t=o.value.split("");for(;t.length&&" "==t[t.length-1];)t.pop();o.value=t.join("")}o=null}}return t.pop(),t}(n,e)}function x(t,e,n,i){let r={type:P},o={type:O,value:t[e].value.substring(n+(i?1:0))};return t.splice(e+1,0,r,o),t[e].value.substring(0,n)}const j={4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},C={VK_CANCEL:3,VK_HELP:6,VK_BACK_SPACE:8,VK_TAB:9,VK_CLEAR:12,VK_RETURN:13,VK_ENTER:14,VK_SHIFT:16,VK_CONTROL:17,VK_ALT:18,VK_PAUSE:19,VK_CAPS_LOCK:20,VK_ESCAPE:27,VK_SPACE:32,VK_PAGE_UP:33,VK_PAGE_DOWN:34,VK_END:35,VK_HOME:36,VK_LEFT:37,VK_UP:38,VK_RIGHT:39,VK_DOWN:40,VK_PRINTSCREEN:44,VK_INSERT:45,VK_DELETE:46,VK_0:48,VK_1:49,VK_2:50,VK_3:51,VK_4:52,VK_5:53,VK_6:54,VK_7:55,VK_8:56,VK_9:57,VK_COLON:58,VK_SEMICOLON:59,VK_LESS_THAN:60,VK_EQUALS:61,VK_GREATER_THAN:62,VK_QUESTION_MARK:63,VK_AT:64,VK_A:65,VK_B:66,VK_C:67,VK_D:68,VK_E:69,VK_F:70,VK_G:71,VK_H:72,VK_I:73,VK_J:74,VK_K:75,VK_L:76,VK_M:77,VK_N:78,VK_O:79,VK_P:80,VK_Q:81,VK_R:82,VK_S:83,VK_T:84,VK_U:85,VK_V:86,VK_W:87,VK_X:88,VK_Y:89,VK_Z:90,VK_CONTEXT_MENU:93,VK_NUMPAD0:96,VK_NUMPAD1:97,VK_NUMPAD2:98,VK_NUMPAD3:99,VK_NUMPAD4:100,VK_NUMPAD5:101,VK_NUMPAD6:102,VK_NUMPAD7:103,VK_NUMPAD8:104,VK_NUMPAD9:105,VK_MULTIPLY:106,VK_ADD:107,VK_SEPARATOR:108,VK_SUBTRACT:109,VK_DECIMAL:110,VK_DIVIDE:111,VK_F1:112,VK_F2:113,VK_F3:114,VK_F4:115,VK_F5:116,VK_F6:117,VK_F7:118,VK_F8:119,VK_F9:120,VK_F10:121,VK_F11:122,VK_F12:123,VK_F13:124,VK_F14:125,VK_F15:126,VK_F16:127,VK_F17:128,VK_F18:129,VK_F19:130,VK_F20:131,VK_F21:132,VK_F22:133,VK_F23:134,VK_F24:135,VK_NUM_LOCK:144,VK_SCROLL_LOCK:145,VK_CIRCUMFLEX:160,VK_EXCLAMATION:161,VK_DOUBLE_QUOTE:162,VK_HASH:163,VK_DOLLAR:164,VK_PERCENT:165,VK_AMPERSAND:166,VK_UNDERSCORE:167,VK_OPEN_PAREN:168,VK_CLOSE_PAREN:169,VK_ASTERISK:170,VK_PLUS:171,VK_PIPE:172,VK_HYPHEN_MINUS:173,VK_OPEN_CURLY_BRACKET:174,VK_CLOSE_CURLY_BRACKET:175,VK_TILDE:176,VK_COMMA:188,VK_PERIOD:190,VK_SLASH:191,VK_BACK_QUOTE:192,VK_OPEN_BRACKET:219,VK_BACK_SLASH:220,VK_CLOSE_BRACKET:221,VK_QUOTE:222,VK_META:224,VK_ALTGR:225,VK_WIN:91,VK_KANA:21,VK_HANGUL:21,VK_EISU:22,VK_JUNJA:23,VK_FINAL:24,VK_HANJA:25,VK_KANJI:25,VK_CONVERT:28,VK_NONCONVERT:29,VK_ACCEPT:30,VK_MODECHANGE:31,VK_SELECT:41,VK_PRINT:42,VK_EXECUTE:43,VK_SLEEP:95},M={hex:h,rect:u,tile:f,"tile-gl":_,term:v.a},R={width:80,height:25,transpose:!1,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1};class A{constructor(t={}){this._data={},this._dirty=!1,this._options={},t=Object.assign({},R,t),this.setOptions(t),this.DEBUG=this.DEBUG.bind(this),this._tick=this._tick.bind(this),this._backend.schedule(this._tick)}DEBUG(t,e,n){let i=[this._options.bg,this._options.fg];this.draw(t,e,null,null,i[n%i.length])}clear(){this._data={},this._dirty=!0}setOptions(t){if(Object.assign(this._options,t),t.width||t.height||t.fontSize||t.fontFamily||t.spacing||t.layout){if(t.layout){let e=M[t.layout];this._backend=new e}this._backend.setOptions(this._options),this._dirty=!0}return this}getOptions(){return this._options}getContainer(){return this._backend.getContainer()}computeSize(t,e){return this._backend.computeSize(t,e)}computeFontSize(t,e){return this._backend.computeFontSize(t,e)}computeTileSize(t,e){return[Math.floor(t/this._options.width),Math.floor(e/this._options.height)]}eventToPosition(t){let e,n;return"touches"in t?(e=t.touches[0].clientX,n=t.touches[0].clientY):(e=t.clientX,n=t.clientY),this._backend.eventToPosition(e,n)}draw(t,e,n,i,r){i||(i=this._options.fg),r||(r=this._options.bg);let o=`${t},${e}`;this._data[o]=[t,e,n,i,r],!0!==this._dirty&&(this._dirty||(this._dirty={}),this._dirty[o]=!0)}drawText(t,e,n,i){let r=null,o=null,s=t,a=e,l=1;i||(i=this._options.width-t);let c=T(n,i);for(;c.length;){let e=c.shift();switch(e.type){case O:let n=!1,i=!1,c=!1,h=!1;for(let t=0;t<e.value.length;t++){let l=e.value.charCodeAt(t),u=e.value.charAt(t);c=l>65280&&l<65377||l>65500&&l<65512||l>65518,n=32==u.charCodeAt(0)||12288==u.charCodeAt(0),!h||c||n||s++,c&&!i&&s++,this.draw(s++,a,u,r,o),i=n,h=c}break;case k:r=e.value||null;break;case E:o=e.value||null;break;case P:s=t,a++,l++}}return l}_tick(){if(this._backend.schedule(this._tick),this._dirty){if(!0===this._dirty){this._backend.clear();for(let t in this._data)this._draw(t,!1)}else for(let t in this._dirty)this._draw(t,!0);this._dirty=!1}}_draw(t,e){let n=this._data[t];n[4]!=this._options.bg&&(e=!0),this._backend.draw(n,e)}}A.Rect=u,A.Hex=h,A.Tile=f,A.TileGL=_,A.Term=v.a;class K{constructor(){this._time=0,this._events=[],this._eventTimes=[]}getTime(){return this._time}clear(){return this._events=[],this._eventTimes=[],this}add(t,e){let n=this._events.length;for(let t=0;t<this._eventTimes.length;t++)if(this._eventTimes[t]>e){n=t;break}this._events.splice(n,0,t),this._eventTimes.splice(n,0,e)}get(){if(!this._events.length)return null;let t=this._eventTimes.splice(0,1)[0];if(t>0){this._time+=t;for(let e=0;e<this._eventTimes.length;e++)this._eventTimes[e]-=t}return this._events.splice(0,1)[0]}getEventTime(t){let e=this._events.indexOf(t);if(-1!=e)return this._eventTimes[e]}remove(t){let e=this._events.indexOf(t);return-1!=e&&(this._remove(e),!0)}_remove(t){this._events.splice(t,1),this._eventTimes.splice(t,1)}}class V{constructor(){this._queue=new K,this._repeat=[],this._current=null}getTime(){return this._queue.getTime()}add(t,e){return e&&this._repeat.push(t),this}getTimeOf(t){return this._queue.getEventTime(t)}clear(){return this._queue.clear(),this._repeat=[],this._current=null,this}remove(t){let e=this._queue.remove(t),n=this._repeat.indexOf(t);return-1!=n&&this._repeat.splice(n,1),this._current==t&&(this._current=null),e}next(){return this._current=this._queue.get(),this._current}}var D={Simple:class extends V{add(t,e){return this._queue.add(t,0),super.add(t,e)}next(){return null!==this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,0),super.next()}},Speed:class extends V{add(t,e,n){return this._queue.add(t,void 0!==n?n:1/t.getSpeed()),super.add(t,e)}next(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,1/this._current.getSpeed()),super.next()}},Action:class extends V{constructor(){super(),this._defaultDuration=1,this._duration=this._defaultDuration}add(t,e,n){return this._queue.add(t,n||this._defaultDuration),super.add(t,e)}clear(){return this._duration=this._defaultDuration,super.clear()}remove(t){return t==this._current&&(this._duration=this._defaultDuration),super.remove(t)}next(){return null!==this._current&&-1!=this._repeat.indexOf(this._current)&&(this._queue.add(this._current,this._duration||this._defaultDuration),this._duration=this._defaultDuration),super.next()}setDuration(t){return this._current&&(this._duration=t),this}}};class U{constructor(t,e={}){this._lightPasses=t,this._options=Object.assign({topology:8},e)}_getCircle(t,e,n){let i,r,o,s=[];switch(this._options.topology){case 4:r=1,o=[0,1],i=[j[8][7],j[8][1],j[8][3],j[8][5]];break;case 6:i=j[6],r=1,o=[-1,1];break;case 8:i=j[4],r=2,o=[-1,1];break;default:throw new Error("Incorrect topology for FOV computation")}let a=t+o[0]*n,l=e+o[1]*n;for(let t=0;t<i.length;t++)for(let e=0;e<n*r;e++)s.push([a,l]),a+=i[t][0],l+=i[t][1];return s}}const L=[[-1,0,0,1],[0,-1,1,0],[0,-1,-1,0],[-1,0,0,-1],[1,0,0,-1],[0,1,-1,0],[0,1,1,0],[1,0,0,1]];var I={DiscreteShadowcasting:class extends U{compute(t,e,n,i){if(i(t,e,0,1),!this._lightPasses(t,e))return;let r,o,s,a,l,c=[];for(let h=1;h<=n;h++){let n=this._getCircle(t,e,h),u=360/n.length;for(let t=0;t<n.length;t++)if(s=n[t][0],a=n[t][1],r=u*(t-.5),o=r+u,l=!this._lightPasses(s,a),this._visibleCoords(Math.floor(r),Math.ceil(o),l,c)&&i(s,a,h,1),2==c.length&&0==c[0]&&360==c[1])return}}_visibleCoords(t,e,n,i){if(t<0){let r=this._visibleCoords(0,e,n,i),o=this._visibleCoords(360+t,360,n,i);return r||o}let r=0;for(;r<i.length&&i[r]<t;)r++;if(r==i.length)return n&&i.push(t,e),!0;let o=0;if(r%2){for(;r<i.length&&i[r]<e;)r++,o++;return 0!=o&&(n&&(o%2?i.splice(r-o,o,e):i.splice(r-o,o)),!0)}for(;r<i.length&&i[r]<e;)r++,o++;return(t!=i[r-o]||1!=o)&&(n&&(o%2?i.splice(r-o,o,t):i.splice(r-o,o,t,e)),!0)}},PreciseShadowcasting:class extends U{compute(t,e,n,i){if(i(t,e,0,1),!this._lightPasses(t,e))return;let r,o,s,a,l,c,h=[];for(let u=1;u<=n;u++){let n=this._getCircle(t,e,u),f=n.length;for(let t=0;t<f;t++)if(r=n[t][0],o=n[t][1],a=[t?2*t-1:2*f-1,2*f],l=[2*t+1,2*f],s=!this._lightPasses(r,o),c=this._checkVisibility(a,l,s,h),c&&i(r,o,u,c),2==h.length&&0==h[0][0]&&h[1][0]==h[1][1])return}}_checkVisibility(t,e,n,i){if(t[0]>e[0]){return(this._checkVisibility(t,[t[1],t[1]],n,i)+this._checkVisibility([0,1],e,n,i))/2}let r=0,o=!1;for(;r<i.length;){let e=i[r],n=e[0]*t[1]-t[0]*e[1];if(n>=0){0!=n||r%2||(o=!0);break}r++}let s=i.length,a=!1;for(;s--;){let t=i[s],n=e[0]*t[1]-t[0]*e[1];if(n>=0){0==n&&s%2&&(a=!0);break}}let l,c=!0;if(r==s&&(o||a)?c=!1:o&&a&&r+1==s&&s%2?c=!1:r>s&&r%2&&(c=!1),!c)return 0;let h=s-r+1;if(h%2)if(r%2){let t=i[r];l=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),n&&i.splice(r,h,e)}else{let e=i[s];l=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),n&&i.splice(r,h,t)}else{if(!(r%2))return n&&i.splice(r,h,t,e),1;{let t=i[r],e=i[s];l=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),n&&i.splice(r,h)}}return l/((e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]))}},RecursiveShadowcasting:class extends U{compute(t,e,n,i){i(t,e,0,1);for(let r=0;r<L.length;r++)this._renderOctant(t,e,L[r],n,i)}compute180(t,e,n,i,r){r(t,e,0,1);let o=(i-1+8)%8,s=(i-2+8)%8,a=(i+1+8)%8;this._renderOctant(t,e,L[s],n,r),this._renderOctant(t,e,L[o],n,r),this._renderOctant(t,e,L[i],n,r),this._renderOctant(t,e,L[a],n,r)}compute90(t,e,n,i,r){r(t,e,0,1);let o=(i-1+8)%8;this._renderOctant(t,e,L[i],n,r),this._renderOctant(t,e,L[o],n,r)}_renderOctant(t,e,n,i,r){this._castVisibility(t,e,1,1,0,i+1,n[0],n[1],n[2],n[3],r)}_castVisibility(t,e,n,i,r,o,s,a,l,c,h){if(!(i<r))for(let u=n;u<=o;u++){let n=-u-1,f=-u,p=!1,_=0;for(;n<=0;){n+=1;let g=t+n*s+f*a,d=e+n*l+f*c,y=(n-.5)/(f+.5),m=(n+.5)/(f-.5);if(!(m>i)){if(y<r)break;if(n*n+f*f<o*o&&h(g,d,u,1),p){if(!this._lightPasses(g,d)){_=m;continue}p=!1,i=_}else!this._lightPasses(g,d)&&u<o&&(p=!0,this._castVisibility(t,e,u+1,i,y,o,s,a,l,c,h),_=m)}}if(p)break}}}};class W{constructor(t=80,e=25){this._width=t,this._height=e}_fillMap(t){let e=[];for(let n=0;n<this._width;n++){e.push([]);for(let i=0;i<this._height;i++)e[n].push(t)}return e}}class N extends W{constructor(t,e){super(t,e),this._rooms=[],this._corridors=[]}getRooms(){return this._rooms}getCorridors(){return this._corridors}}class F{}class z extends F{constructor(t,e,n,i,r,o){super(),this._x1=t,this._y1=e,this._x2=n,this._y2=i,this._doors={},void 0!==r&&void 0!==o&&this.addDoor(r,o)}static createRandomAt(t,e,n,i,r){let o=r.roomWidth[0],a=r.roomWidth[1],l=s.a.getUniformInt(o,a);o=r.roomHeight[0],a=r.roomHeight[1];let c=s.a.getUniformInt(o,a);if(1==n){let n=e-Math.floor(s.a.getUniform()*c);return new this(t+1,n,t+l,n+c-1,t,e)}if(-1==n){let n=e-Math.floor(s.a.getUniform()*c);return new this(t-l,n,t-1,n+c-1,t,e)}if(1==i){let n=t-Math.floor(s.a.getUniform()*l);return new this(n,e+1,n+l-1,e+c,t,e)}if(-1==i){let n=t-Math.floor(s.a.getUniform()*l);return new this(n,e-c,n+l-1,e-1,t,e)}throw new Error("dx or dy must be 1 or -1")}static createRandomCenter(t,e,n){let i=n.roomWidth[0],r=n.roomWidth[1],o=s.a.getUniformInt(i,r);i=n.roomHeight[0],r=n.roomHeight[1];let a=s.a.getUniformInt(i,r),l=t-Math.floor(s.a.getUniform()*o),c=e-Math.floor(s.a.getUniform()*a);return new this(l,c,l+o-1,c+a-1)}static createRandom(t,e,n){let i=n.roomWidth[0],r=n.roomWidth[1],o=s.a.getUniformInt(i,r);i=n.roomHeight[0],r=n.roomHeight[1];let a=s.a.getUniformInt(i,r),l=t-o-1,c=e-a-1,h=1+Math.floor(s.a.getUniform()*l),u=1+Math.floor(s.a.getUniform()*c);return new this(h,u,h+o-1,u+a-1)}addDoor(t,e){return this._doors[t+","+e]=1,this}getDoors(t){for(let e in this._doors){let n=e.split(",");t(parseInt(n[0]),parseInt(n[1]))}return this}clearDoors(){return this._doors={},this}addDoors(t){let e=this._x1-1,n=this._x2+1,i=this._y1-1,r=this._y2+1;for(let o=e;o<=n;o++)for(let s=i;s<=r;s++)o!=e&&o!=n&&s!=i&&s!=r||t(o,s)||this.addDoor(o,s);return this}debug(){console.log("room",this._x1,this._y1,this._x2,this._y2)}isValid(t,e){let n=this._x1-1,i=this._x2+1,r=this._y1-1,o=this._y2+1;for(let s=n;s<=i;s++)for(let a=r;a<=o;a++)if(s==n||s==i||a==r||a==o){if(!t(s,a))return!1}else if(!e(s,a))return!1;return!0}create(t){let e=this._x1-1,n=this._x2+1,i=this._y1-1,r=this._y2+1,o=0;for(let s=e;s<=n;s++)for(let a=i;a<=r;a++)o=s+","+a in this._doors?2:s==e||s==n||a==i||a==r?1:0,t(s,a,o)}getCenter(){return[Math.round((this._x1+this._x2)/2),Math.round((this._y1+this._y2)/2)]}getLeft(){return this._x1}getRight(){return this._x2}getTop(){return this._y1}getBottom(){return this._y2}}class H extends F{constructor(t,e,n,i){super(),this._startX=t,this._startY=e,this._endX=n,this._endY=i,this._endsWithAWall=!0}static createRandomAt(t,e,n,i,r){let o=r.corridorLength[0],a=r.corridorLength[1],l=s.a.getUniformInt(o,a);return new this(t,e,t+n*l,e+i*l)}debug(){console.log("corridor",this._startX,this._startY,this._endX,this._endY)}isValid(t,e){let n=this._startX,i=this._startY,r=this._endX-n,o=this._endY-i,s=1+Math.max(Math.abs(r),Math.abs(o));r&&(r/=Math.abs(r)),o&&(o/=Math.abs(o));let a=o,l=-r,c=!0;for(let h=0;h<s;h++){let u=n+h*r,f=i+h*o;if(e(u,f)||(c=!1),t(u+a,f+l)||(c=!1),t(u-a,f-l)||(c=!1),!c){s=h,this._endX=u-r,this._endY=f-o;break}}if(0==s)return!1;if(1==s&&t(this._endX+r,this._endY+o))return!1;let h=!t(this._endX+r+a,this._endY+o+l),u=!t(this._endX+r-a,this._endY+o-l);return this._endsWithAWall=t(this._endX+r,this._endY+o),!h&&!u||!this._endsWithAWall}create(t){let e=this._startX,n=this._startY,i=this._endX-e,r=this._endY-n,o=1+Math.max(Math.abs(i),Math.abs(r));i&&(i/=Math.abs(i)),r&&(r/=Math.abs(r));for(let s=0;s<o;s++){t(e+s*i,n+s*r,0)}return!0}createPriorityWalls(t){if(!this._endsWithAWall)return;let e=this._startX,n=this._startY,i=this._endX-e,r=this._endY-n;i&&(i/=Math.abs(i)),r&&(r/=Math.abs(r));let o=r,s=-i;t(this._endX+i,this._endY+r),t(this._endX+o,this._endY+s),t(this._endX-o,this._endY-s)}}const X={room:z,corridor:H};function G(t,e,n){n[e[t+1]]=n[t],e[n[t]]=e[t+1],n[t]=t+1,e[t+1]=t}function B(t,e,n){n[e[t]]=n[t],e[n[t]]=e[t],n[t]=t,e[t]=t}var Y={Arena:class extends W{create(t){let e=this._width-1,n=this._height-1;for(let i=0;i<=e;i++)for(let r=0;r<=n;r++){t(i,r,i&&r&&i<e&&r<n?0:1)}return this}},Uniform:class extends N{constructor(t,e,n){super(t,e),this._options={roomWidth:[3,9],roomHeight:[3,5],roomDugPercentage:.1,timeLimit:1e3},Object.assign(this._options,n),this._map=[],this._dug=0,this._roomAttempts=20,this._corridorAttempts=20,this._connected=[],this._unconnected=[],this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this)}create(t){let e=Date.now();for(;;){if(Date.now()-e>this._options.timeLimit)return null;if(this._map=this._fillMap(1),this._dug=0,this._rooms=[],this._unconnected=[],this._generateRooms(),!(this._rooms.length<2)&&this._generateCorridors())break}if(t)for(let e=0;e<this._width;e++)for(let n=0;n<this._height;n++)t(e,n,this._map[e][n]);return this}_generateRooms(){let t,e=this._width-2,n=this._height-2;do{if(t=this._generateRoom(),this._dug/(e*n)>this._options.roomDugPercentage)break}while(t)}_generateRoom(){let t=0;for(;t<this._roomAttempts;){t++;let e=z.createRandom(this._width,this._height,this._options);if(e.isValid(this._isWallCallback,this._canBeDugCallback))return e.create(this._digCallback),this._rooms.push(e),e}return null}_generateCorridors(){let t=0;for(;t<this._corridorAttempts;){t++,this._corridors=[],this._map=this._fillMap(1);for(let t=0;t<this._rooms.length;t++){let e=this._rooms[t];e.clearDoors(),e.create(this._digCallback)}for(this._unconnected=s.a.shuffle(this._rooms.slice()),this._connected=[],this._unconnected.length&&this._connected.push(this._unconnected.pop());;){let t=s.a.getItem(this._connected);if(!t)break;let e=this._closestRoom(this._unconnected,t);if(!e)break;let n=this._closestRoom(this._connected,e);if(!n)break;if(!this._connectRooms(e,n))break;if(!this._unconnected.length)return!0}}return!1}_closestRoom(t,e){let n=1/0,i=e.getCenter(),r=null;for(let e=0;e<t.length;e++){let o=t[e],s=o.getCenter(),a=s[0]-i[0],l=s[1]-i[1],c=a*a+l*l;c<n&&(n=c,r=o)}return r}_connectRooms(t,e){let n,i,r,o,s,a,l,c=t.getCenter(),h=e.getCenter(),u=h[0]-c[0],f=h[1]-c[1];if(Math.abs(u)<Math.abs(f)?(r=f>0?2:0,o=(r+2)%4,s=e.getLeft(),a=e.getRight(),l=0):(r=u>0?1:3,o=(r+2)%4,s=e.getTop(),a=e.getBottom(),l=1),n=this._placeInWall(t,r),!n)return!1;if(n[l]>=s&&n[l]<=a){i=n.slice();let t=0;switch(o){case 0:t=e.getTop()-1;break;case 1:t=e.getRight()+1;break;case 2:t=e.getBottom()+1;break;case 3:t=e.getLeft()-1}i[(l+1)%2]=t,this._digLine([n,i])}else if(n[l]<s-1||n[l]>a+1){let t=n[l]-h[l],r=0;switch(o){case 0:case 1:r=t<0?3:1;break;case 2:case 3:r=t<0?1:3}if(o=(o+r)%4,i=this._placeInWall(e,o),!i)return!1;let s=[0,0];s[l]=n[l];let a=(l+1)%2;s[a]=i[a],this._digLine([n,s,i])}else{let t=(l+1)%2;if(i=this._placeInWall(e,o),!i)return!1;let r=Math.round((i[t]+n[t])/2),s=[0,0],a=[0,0];s[l]=n[l],s[t]=r,a[l]=i[l],a[t]=r,this._digLine([n,s,a,i])}return t.addDoor(n[0],n[1]),e.addDoor(i[0],i[1]),l=this._unconnected.indexOf(t),-1!=l&&(this._unconnected.splice(l,1),this._connected.push(t)),l=this._unconnected.indexOf(e),-1!=l&&(this._unconnected.splice(l,1),this._connected.push(e)),!0}_placeInWall(t,e){let n=[0,0],i=[0,0],r=0;switch(e){case 0:i=[1,0],n=[t.getLeft(),t.getTop()-1],r=t.getRight()-t.getLeft()+1;break;case 1:i=[0,1],n=[t.getRight()+1,t.getTop()],r=t.getBottom()-t.getTop()+1;break;case 2:i=[1,0],n=[t.getLeft(),t.getBottom()+1],r=t.getRight()-t.getLeft()+1;break;case 3:i=[0,1],n=[t.getLeft()-1,t.getTop()],r=t.getBottom()-t.getTop()+1}let o=[],a=-2;for(let t=0;t<r;t++){let e=n[0]+t*i[0],r=n[1]+t*i[1];o.push(null),1==this._map[e][r]?a!=t-1&&(o[t]=[e,r]):(a=t,t&&(o[t-1]=null))}for(let t=o.length-1;t>=0;t--)o[t]||o.splice(t,1);return o.length?s.a.getItem(o):null}_digLine(t){for(let e=1;e<t.length;e++){let n=t[e-1],i=t[e],r=new H(n[0],n[1],i[0],i[1]);r.create(this._digCallback),this._corridors.push(r)}}_digCallback(t,e,n){this._map[t][e]=n,0==n&&this._dug++}_isWallCallback(t,e){return!(t<0||e<0||t>=this._width||e>=this._height)&&1==this._map[t][e]}_canBeDugCallback(t,e){return!(t<1||e<1||t+1>=this._width||e+1>=this._height)&&1==this._map[t][e]}},Cellular:class extends W{constructor(t,e,n={}){super(t,e),this._options={born:[5,6,7,8],survive:[4,5,6,7,8],topology:8},this.setOptions(n),this._dirs=j[this._options.topology],this._map=this._fillMap(0)}randomize(t){for(let e=0;e<this._width;e++)for(let n=0;n<this._height;n++)this._map[e][n]=s.a.getUniform()<t?1:0;return this}setOptions(t){Object.assign(this._options,t)}set(t,e,n){this._map[t][e]=n}create(t){let e=this._fillMap(0),n=this._options.born,i=this._options.survive;for(let t=0;t<this._height;t++){let r=1,o=0;6==this._options.topology&&(r=2,o=t%2);for(let s=o;s<this._width;s+=r){let r=this._map[s][t],o=this._getNeighbors(s,t);r&&-1!=i.indexOf(o)?e[s][t]=1:r||-1==n.indexOf(o)||(e[s][t]=1)}}this._map=e,t&&this._serviceCallback(t)}_serviceCallback(t){for(let e=0;e<this._height;e++){let n=1,i=0;6==this._options.topology&&(n=2,i=e%2);for(let r=i;r<this._width;r+=n)t(r,e,this._map[r][e])}}_getNeighbors(t,e){let n=0;for(let i=0;i<this._dirs.length;i++){let r=this._dirs[i],o=t+r[0],s=e+r[1];o<0||o>=this._width||s<0||s>=this._height||(n+=1==this._map[o][s]?1:0)}return n}connect(t,e,n){e||(e=0);let i=[],r={},o=1,a=[0,0];6==this._options.topology&&(o=2,a=[0,1]);for(let t=0;t<this._height;t++)for(let n=a[t%2];n<this._width;n+=o)if(this._freeSpace(n,t,e)){let e=[n,t];r[this._pointKey(e)]=e,i.push([n,t])}let l=i[s.a.getUniformInt(0,i.length-1)],c=this._pointKey(l),h={};for(h[c]=l,delete r[c],this._findConnected(h,r,[l],!1,e);Object.keys(r).length>0;){let t=this._getFromTo(h,r),i=t[0],o=t[1],s={};s[this._pointKey(i)]=i,this._findConnected(s,r,[i],!0,e),(6==this._options.topology?this._tunnelToConnected6:this._tunnelToConnected).call(this,o,i,h,r,e,n);for(let t in s){let n=s[t];this._map[n[0]][n[1]]=e,h[t]=n,delete r[t]}}t&&this._serviceCallback(t)}_getFromTo(t,e){let n,i=[0,0],r=[0,0],o=Object.keys(t),a=Object.keys(e);for(let l=0;l<5;l++){if(o.length<a.length){let n=o;r=t[n[s.a.getUniformInt(0,n.length-1)]],i=this._getClosest(r,e)}else{let n=a;i=e[n[s.a.getUniformInt(0,n.length-1)]],r=this._getClosest(i,t)}if(n=(i[0]-r[0])*(i[0]-r[0])+(i[1]-r[1])*(i[1]-r[1]),n<64)break}return[i,r]}_getClosest(t,e){let n=null,i=null;for(let r in e){let o=e[r],s=(o[0]-t[0])*(o[0]-t[0])+(o[1]-t[1])*(o[1]-t[1]);(null==i||s<i)&&(i=s,n=o)}return n}_findConnected(t,e,n,i,r){for(;n.length>0;){let o,s=n.splice(0,1)[0];o=6==this._options.topology?[[s[0]+2,s[1]],[s[0]+1,s[1]-1],[s[0]-1,s[1]-1],[s[0]-2,s[1]],[s[0]-1,s[1]+1],[s[0]+1,s[1]+1]]:[[s[0]+1,s[1]],[s[0]-1,s[1]],[s[0],s[1]+1],[s[0],s[1]-1]];for(let s=0;s<o.length;s++){let a=this._pointKey(o[s]);null==t[a]&&this._freeSpace(o[s][0],o[s][1],r)&&(t[a]=o[s],i||delete e[a],n.push(o[s]))}}}_tunnelToConnected(t,e,n,i,r,o){let s,a;e[0]<t[0]?(s=e,a=t):(s=t,a=e);for(let t=s[0];t<=a[0];t++){this._map[t][s[1]]=r;let e=[t,s[1]],o=this._pointKey(e);n[o]=e,delete i[o]}o&&s[0]<a[0]&&o(s,[a[0],s[1]]);let l=a[0];e[1]<t[1]?(s=e,a=t):(s=t,a=e);for(let t=s[1];t<a[1];t++){this._map[l][t]=r;let e=[l,t],o=this._pointKey(e);n[o]=e,delete i[o]}o&&s[1]<a[1]&&o([a[0],s[1]],[a[0],a[1]])}_tunnelToConnected6(t,e,n,i,r,o){let s,a;e[0]<t[0]?(s=e,a=t):(s=t,a=e);let l=s[0],c=s[1];for(;l!=a[0]||c!=a[1];){let t=2;c<a[1]?(c++,t=1):c>a[1]&&(c--,t=1),l<a[0]?l+=t:l>a[0]?l-=t:a[1]%2?l-=t:l+=t,this._map[l][c]=r;let e=[l,c],o=this._pointKey(e);n[o]=e,delete i[o]}o&&o(e,t)}_freeSpace(t,e,n){return t>=0&&t<this._width&&e>=0&&e<this._height&&this._map[t][e]==n}_pointKey(t){return t[0]+"."+t[1]}},Digger:class extends N{constructor(t,e,n={}){super(t,e),this._options=Object.assign({roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:.2,timeLimit:1e3},n),this._features={room:4,corridor:4},this._map=[],this._featureAttempts=20,this._walls={},this._dug=0,this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this),this._priorityWallCallback=this._priorityWallCallback.bind(this)}create(t){this._rooms=[],this._corridors=[],this._map=this._fillMap(1),this._walls={},this._dug=0;let e=(this._width-2)*(this._height-2);this._firstRoom();let n,i=Date.now();do{if(n=0,Date.now()-i>this._options.timeLimit)break;let t=this._findWall();if(!t)break;let e=t.split(","),r=parseInt(e[0]),o=parseInt(e[1]),s=this._getDiggingDirection(r,o);if(!s)continue;let a=0;do{if(a++,this._tryFeature(r,o,s[0],s[1])){this._removeSurroundingWalls(r,o),this._removeSurroundingWalls(r-s[0],o-s[1]);break}}while(a<this._featureAttempts);for(let t in this._walls)this._walls[t]>1&&n++}while(this._dug/e<this._options.dugPercentage||n);if(this._addDoors(),t)for(let e=0;e<this._width;e++)for(let n=0;n<this._height;n++)t(e,n,this._map[e][n]);return this._walls={},this._map=[],this}_digCallback(t,e,n){0==n||2==n?(this._map[t][e]=0,this._dug++):this._walls[t+","+e]=1}_isWallCallback(t,e){return!(t<0||e<0||t>=this._width||e>=this._height)&&1==this._map[t][e]}_canBeDugCallback(t,e){return!(t<1||e<1||t+1>=this._width||e+1>=this._height)&&1==this._map[t][e]}_priorityWallCallback(t,e){this._walls[t+","+e]=2}_firstRoom(){let t=Math.floor(this._width/2),e=Math.floor(this._height/2),n=z.createRandomCenter(t,e,this._options);this._rooms.push(n),n.create(this._digCallback)}_findWall(){let t=[],e=[];for(let n in this._walls){2==this._walls[n]?e.push(n):t.push(n)}let n=e.length?e:t;if(!n.length)return null;let i=s.a.getItem(n.sort());return delete this._walls[i],i}_tryFeature(t,e,n,i){let r=s.a.getWeightedValue(this._features),o=X[r].createRandomAt(t,e,n,i,this._options);return!!o.isValid(this._isWallCallback,this._canBeDugCallback)&&(o.create(this._digCallback),o instanceof z&&this._rooms.push(o),o instanceof H&&(o.createPriorityWalls(this._priorityWallCallback),this._corridors.push(o)),!0)}_removeSurroundingWalls(t,e){let n=j[4];for(let i=0;i<n.length;i++){let r=n[i],o=t+r[0],s=e+r[1];delete this._walls[o+","+s],o=t+2*r[0],s=e+2*r[1],delete this._walls[o+","+s]}}_getDiggingDirection(t,e){if(t<=0||e<=0||t>=this._width-1||e>=this._height-1)return null;let n=null,i=j[4];for(let r=0;r<i.length;r++){let o=i[r],s=t+o[0],a=e+o[1];if(!this._map[s][a]){if(n)return null;n=o}}return n?[-n[0],-n[1]]:null}_addDoors(){let t=this._map;function e(e,n){return 1==t[e][n]}for(let t=0;t<this._rooms.length;t++){let n=this._rooms[t];n.clearDoors(),n.addDoors(e)}}},EllerMaze:class extends W{create(t){let e,n=this._fillMap(1),i=Math.ceil((this._width-2)/2),r=[],o=[];for(let t=0;t<i;t++)r.push(t),o.push(t);for(r.push(i-1),e=1;e+3<this._height;e+=2)for(let t=0;t<i;t++){let i=2*t+1,a=e;n[i][a]=0,t!=r[t+1]&&s.a.getUniform()>.375&&(G(t,r,o),n[i+1][a]=0),t!=r[t]&&s.a.getUniform()>.375?B(t,r,o):n[i][a+1]=0}for(let t=0;t<i;t++){let i=2*t+1,a=e;n[i][a]=0,t!=r[t+1]&&(t==r[t]||s.a.getUniform()>.375)&&(G(t,r,o),n[i+1][a]=0),B(t,r,o)}for(let e=0;e<this._width;e++)for(let i=0;i<this._height;i++)t(e,i,n[e][i]);return this}},DividedMaze:class extends W{constructor(){super(...arguments),this._stack=[],this._map=[]}create(t){let e=this._width,n=this._height;this._map=[];for(let t=0;t<e;t++){this._map.push([]);for(let i=0;i<n;i++){let r=0==t||0==i||t+1==e||i+1==n;this._map[t].push(r?1:0)}}this._stack=[[1,1,e-2,n-2]],this._process();for(let i=0;i<e;i++)for(let e=0;e<n;e++)t(i,e,this._map[i][e]);return this._map=[],this}_process(){for(;this._stack.length;){let t=this._stack.shift();this._partitionRoom(t)}}_partitionRoom(t){let e=[],n=[];for(let n=t[0]+1;n<t[2];n++){let i=this._map[n][t[1]-1],r=this._map[n][t[3]+1];!i||!r||n%2||e.push(n)}for(let e=t[1]+1;e<t[3];e++){let i=this._map[t[0]-1][e],r=this._map[t[2]+1][e];!i||!r||e%2||n.push(e)}if(!e.length||!n.length)return;let i=s.a.getItem(e),r=s.a.getItem(n);this._map[i][r]=1;let o=[],a=[];o.push(a);for(let e=t[0];e<i;e++)this._map[e][r]=1,a.push([e,r]);a=[],o.push(a);for(let e=i+1;e<=t[2];e++)this._map[e][r]=1,a.push([e,r]);a=[],o.push(a);for(let e=t[1];e<r;e++)this._map[i][e]=1,a.push([i,e]);a=[],o.push(a);for(let e=r+1;e<=t[3];e++)this._map[i][e]=1,a.push([i,e]);let l=s.a.getItem(o);for(let t=0;t<o.length;t++){let e=o[t];if(e==l)continue;let n=s.a.getItem(e);this._map[n[0]][n[1]]=0}this._stack.push([t[0],t[1],i-1,r-1]),this._stack.push([i+1,t[1],t[2],r-1]),this._stack.push([t[0],r+1,i-1,t[3]]),this._stack.push([i+1,r+1,t[2],t[3]])}},IceyMaze:class extends W{constructor(t,e,n=0){super(t,e),this._regularity=n,this._map=[]}create(t){let e=this._width,n=this._height,i=this._fillMap(1);e-=e%2?1:2,n-=n%2?1:2;let r=0,o=0,a=0,l=0,c=0,h=!1,u=[[0,0],[0,0],[0,0],[0,0]];do{if(r=1+2*Math.floor(s.a.getUniform()*(e-1)/2),o=1+2*Math.floor(s.a.getUniform()*(n-1)/2),c||(i[r][o]=0),!i[r][o]){this._randomize(u);do{0==Math.floor(s.a.getUniform()*(this._regularity+1))&&this._randomize(u),h=!0;for(let t=0;t<4;t++)if(a=r+2*u[t][0],l=o+2*u[t][1],this._isFree(i,a,l,e,n)){i[a][l]=0,i[r+u[t][0]][o+u[t][1]]=0,r=a,o=l,h=!1,c++;break}}while(!h)}}while(c+1<e*n/4);for(let e=0;e<this._width;e++)for(let n=0;n<this._height;n++)t(e,n,i[e][n]);return this._map=[],this}_randomize(t){for(let e=0;e<4;e++)t[e][0]=0,t[e][1]=0;switch(Math.floor(4*s.a.getUniform())){case 0:t[0][0]=-1,t[1][0]=1,t[2][1]=-1,t[3][1]=1;break;case 1:t[3][0]=-1,t[2][0]=1,t[1][1]=-1,t[0][1]=1;break;case 2:t[2][0]=-1,t[3][0]=1,t[0][1]=-1,t[1][1]=1;break;case 3:t[1][0]=-1,t[0][0]=1,t[3][1]=-1,t[2][1]=1}}_isFree(t,e,n,i,r){return!(e<1||n<1||e>=i||n>=r)&&t[e][n]}},Rogue:class extends W{constructor(t,e,n){super(t,e),this.map=[],this.rooms=[],this.connectedCells=[],(n=Object.assign({cellWidth:3,cellHeight:3},n)).hasOwnProperty("roomWidth")||(n.roomWidth=this._calculateRoomSize(this._width,n.cellWidth)),n.hasOwnProperty("roomHeight")||(n.roomHeight=this._calculateRoomSize(this._height,n.cellHeight)),this._options=n}create(t){if(this.map=this._fillMap(1),this.rooms=[],this.connectedCells=[],this._initRooms(),this._connectRooms(),this._connectUnconnectedRooms(),this._createRandomRoomConnections(),this._createRooms(),this._createCorridors(),t)for(let e=0;e<this._width;e++)for(let n=0;n<this._height;n++)t(e,n,this.map[e][n]);return this}_calculateRoomSize(t,e){let n=Math.floor(t/e*.8),i=Math.floor(t/e*.25);return i<2&&(i=2),n<2&&(n=2),[i,n]}_initRooms(){for(let t=0;t<this._options.cellWidth;t++){this.rooms.push([]);for(let e=0;e<this._options.cellHeight;e++)this.rooms[t].push({x:0,y:0,width:0,height:0,connections:[],cellx:t,celly:e})}}_connectRooms(){let t,e,n,i,r,o,a=s.a.getUniformInt(0,this._options.cellWidth-1),l=s.a.getUniformInt(0,this._options.cellHeight-1),c=!1;do{o=[0,2,4,6],o=s.a.shuffle(o);do{if(c=!1,t=o.pop(),e=a+j[8][t][0],n=l+j[8][t][1],!(e<0||e>=this._options.cellWidth||n<0||n>=this._options.cellHeight)){if(i=this.rooms[a][l],i.connections.length>0&&i.connections[0][0]==e&&i.connections[0][1]==n)break;r=this.rooms[e][n],0==r.connections.length&&(r.connections.push([a,l]),this.connectedCells.push([e,n]),a=e,l=n,c=!0)}}while(o.length>0&&0==c)}while(o.length>0)}_connectUnconnectedRooms(){let t,e,n,i=this._options.cellWidth,r=this._options.cellHeight;this.connectedCells=s.a.shuffle(this.connectedCells);for(let o=0;o<this._options.cellWidth;o++)for(let a=0;a<this._options.cellHeight;a++)if(t=this.rooms[o][a],0==t.connections.length){let l=[0,2,4,6];l=s.a.shuffle(l),n=!1;do{let t=l.pop(),s=o+j[8][t][0],c=a+j[8][t][1];if(!(s<0||s>=i||c<0||c>=r)){if(e=this.rooms[s][c],n=!0,0==e.connections.length)break;for(let t=0;t<e.connections.length;t++)if(e.connections[t][0]==o&&e.connections[t][1]==a){n=!1;break}if(n)break}}while(l.length);n?t.connections.push([e.cellx,e.celly]):console.log("-- Unable to connect room.")}}_createRandomRoomConnections(){}_createRooms(){let t,e,n,i,r,o=this._width,a=this._height,l=this._options.cellWidth,c=this._options.cellHeight,h=Math.floor(this._width/l),u=Math.floor(this._height/c),f=this._options.roomWidth,p=this._options.roomHeight;for(let _=0;_<l;_++)for(let l=0;l<c;l++){if(n=h*_,i=u*l,0==n&&(n=1),0==i&&(i=1),t=s.a.getUniformInt(f[0],f[1]),e=s.a.getUniformInt(p[0],p[1]),l>0)for(r=this.rooms[_][l-1];i-(r.y+r.height)<3;)i++;if(_>0)for(r=this.rooms[_-1][l];n-(r.x+r.width)<3;)n++;let c=Math.round(s.a.getUniformInt(0,h-t)/2),g=Math.round(s.a.getUniformInt(0,u-e)/2);for(;n+c+t>=o;)c?c--:t--;for(;i+g+e>=a;)g?g--:e--;n+=c,i+=g,this.rooms[_][l].x=n,this.rooms[_][l].y=i,this.rooms[_][l].width=t,this.rooms[_][l].height=e;for(let r=n;r<n+t;r++)for(let t=i;t<i+e;t++)this.map[r][t]=0}}_getWallPosition(t,e){let n,i,r;return 1==e||3==e?(n=s.a.getUniformInt(t.x+1,t.x+t.width-2),1==e?(i=t.y-2,r=i+1):(i=t.y+t.height+1,r=i-1),this.map[n][r]=0):(i=s.a.getUniformInt(t.y+1,t.y+t.height-2),2==e?(n=t.x+t.width+1,r=n-1):(n=t.x-2,r=n+1),this.map[r][i]=0),[n,i]}_drawCorridor(t,e){let n,i,r,o,a=e[0]-t[0],l=e[1]-t[1],c=t[0],h=t[1],u=[],f=Math.abs(a),p=Math.abs(l),_=s.a.getUniform(),g=_,d=1-_;for(i=a>0?2:6,r=l>0?4:0,f<p?(n=Math.ceil(p*g),u.push([r,n]),u.push([i,f]),n=Math.floor(p*d),u.push([r,n])):(n=Math.ceil(f*g),u.push([i,n]),u.push([r,p]),n=Math.floor(f*d),u.push([i,n])),this.map[c][h]=0;u.length>0;)for(o=u.pop();o[1]>0;)c+=j[8][o[0]][0],h+=j[8][o[0]][1],this.map[c][h]=0,o[1]=o[1]-1}_createCorridors(){let t,e,n,i,r,o=this._options.cellWidth,s=this._options.cellHeight;for(let a=0;a<o;a++)for(let o=0;o<s;o++){t=this.rooms[a][o];for(let o=0;o<t.connections.length;o++)e=t.connections[o],n=this.rooms[e[0]][e[1]],n.cellx>t.cellx?(i=2,r=4):n.cellx<t.cellx?(i=4,r=2):n.celly>t.celly?(i=3,r=1):(i=1,r=3),this._drawCorridor(this._getWallPosition(t,i),this._getWallPosition(n,r))}}}};Math.sqrt(3),Math.sqrt(3);class q{constructor(t){this._scheduler=t,this._lock=1}start(){return this.unlock()}lock(){return this._lock++,this}unlock(){if(!this._lock)throw new Error("Cannot unlock unlocked engine");for(this._lock--;!this._lock;){let t=this._scheduler.next();if(!t)return this.lock();let e=t.act();e&&e.then&&(this.lock(),e.then(this.unlock.bind(this)))}return this}}const $=p;var J=n(3);function Q(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var Z=function(){function t(e){if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.screenName="Screen name not set!",this.game=e.game,!this.game)throw new Error("Screen created without game object")}var e,n,i;return e=t,(n=[{key:"Enter",value:function(){console.log("Entered screen ".concat(this.screenName))}},{key:"Exit",value:function(){console.log("Exited screen ".concat(this.screenName))}},{key:"Render",value:function(t){}},{key:"HandleInput",value:function(t,e){}}])&&Q(e.prototype,n),i&&Q(e,i),t}();function tt(t){return(tt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function et(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function nt(t,e){return!e||"object"!==tt(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function it(t,e,n){return(it="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,n){var i=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=rt(t)););return t}(t,e);if(i){var r=Object.getOwnPropertyDescriptor(i,e);return r.get?r.get.call(n):r.value}})(t,e,n||t)}function rt(t){return(rt=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function ot(t,e){return(ot=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var st=function(t){function e(t){var n;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),(n=nt(this,rt(e).call(this,t))).screenName="Splash screen",n}var n,i,r;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&ot(t,e)}(e,t),n=e,(i=[{key:"Enter",value:function(){it(rt(e.prototype),"Enter",this).call(this)}},{key:"Exit",value:function(){it(rt(e.prototype),"Exit",this).call(this)}},{key:"Render",value:function(t){t.drawText(1,1,"%c{yellow}Javascript Roguelike"),t.drawText(1,2,"Press [Enter] to start!")}},{key:"HandleInput",value:function(t,e){var n=C;"keydown"===t&&e.keyCode===n.VK_RETURN&&this.game.Transition("play")}}])&&et(n.prototype,i),r&&et(n,r),e}(Z);function at(t){return(at="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function lt(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function ct(t,e){return!e||"object"!==at(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function ht(t,e,n){return(ht="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,n){var i=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=ut(t)););return t}(t,e);if(i){var r=Object.getOwnPropertyDescriptor(i,e);return r.get?r.get.call(n):r.value}})(t,e,n||t)}function ut(t){return(ut=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function ft(t,e){return(ft=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var pt=function(t){function e(t){var n;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),(n=ct(this,ut(e).call(this,t))).screenName="Victory screen",n}var n,i,r;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&ft(t,e)}(e,t),n=e,(i=[{key:"Enter",value:function(){ht(ut(e.prototype),"Enter",this).call(this)}},{key:"Exit",value:function(){ht(ut(e.prototype),"Exit",this).call(this)}},{key:"Render",value:function(t){for(var e=0;e<22;e++){var n=Math.round(255*Math.random()),i=Math.round(255*Math.random()),r=Math.round(255*Math.random()),o=$.toRGB([n,i,r]);t.drawText(2,e+1,"%b{"+o+"}You win!")}}},{key:"HandleInput",value:function(t,e){"keydown"===t&&(e.keyCode,this.game.Transition("splash"))}}])&&lt(n.prototype,i),r&&lt(n,r),e}(Z);function _t(t){return(_t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function gt(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function dt(t,e){return!e||"object"!==_t(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function yt(t,e,n){return(yt="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,n){var i=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=mt(t)););return t}(t,e);if(i){var r=Object.getOwnPropertyDescriptor(i,e);return r.get?r.get.call(n):r.value}})(t,e,n||t)}function mt(t){return(mt=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function bt(t,e){return(bt=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var vt=function(t){function e(t){var n;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),(n=dt(this,mt(e).call(this,t))).screenName="Victory screen",n}var n,i,r;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&bt(t,e)}(e,t),n=e,(i=[{key:"Enter",value:function(){yt(mt(e.prototype),"Enter",this).call(this)}},{key:"Exit",value:function(){yt(mt(e.prototype),"Exit",this).call(this)}},{key:"Render",value:function(t){for(var e=0;e<22;e++)t.drawText(2,e+1,"%b{red}You lose! :(")}},{key:"HandleInput",value:function(t,e){"keydown"===t&&(e.keyCode,this.game.Transition("splash"))}}])&&gt(n.prototype,i),r&&gt(n,r),e}(Z);function wt(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function Ot(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var Pt=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};wt(this,t);var n=e.name;this.name=void 0===n?"":n;var i=e.interface;this.interface=void 0===i?"":i,this.entity=null}var e,n,i;return e=t,(n=[{key:"SetEntity",value:function(t){this.entity=t}}])&&Ot(e.prototype,n),i&&Ot(e,i),t}();function kt(t){return(kt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function Et(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function St(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?Et(Object(n),!0).forEach((function(e){Tt(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Et(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function Tt(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function xt(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function jt(t,e){return!e||"object"!==kt(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function Ct(t){return(Ct=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function Mt(t,e){return(Mt=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var Rt=function(t){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};xt(this,e),t=jt(this,Ct(e).call(this,St({},n,{name:"Glyph",interface:"Glyph"})));var i=n.character,r=void 0===i?"":i,o=n.foreground,s=void 0===o?"white":o,a=n.background,l=void 0===a?"black":a;return t.character=r,t.foreground=s,t.background=l,t}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&Mt(t,e)}(e,t),e}(Pt);function At(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function Kt(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var Vt=function(){function t(e){var n=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};At(this,t);var r=i.name;this.name=void 0===r?"":r;var o=i.x;this.x=void 0===o?0:o;var s=i.y;this.y=void 0===s?0:s,this.game=e,this.map=null,this.components={};var a=i.components||[];a.forEach((function(t){t.SetEntity(n),n.components[t.interface]=t,t.name!==t.interface&&(n.components[t.name]=t)}))}var e,n,i;return e=t,(n=[{key:"act",value:function(){this.HasComponent("Actor")&&this.components.Actor.act()}},{key:"SetMap",value:function(t){this.map=t}},{key:"GetComponent",value:function(t){return this.components[t]}},{key:"HasComponent",value:function(t){return void 0!==this.components[t]}},{key:"position",get:function(){return{x:this.x,y:this.y}},set:function(t){var e=this.position;this.x=t.x,this.y=t.y,this.map.UpdateEntityPosition(this,e.x,e.y)}}])&&Kt(e.prototype,n),i&&Kt(e,i),t}(),Dt=n(6);function Ut(t){return(Ut="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function Lt(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function It(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?Lt(Object(n),!0).forEach((function(e){Wt(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Lt(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function Wt(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function Nt(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function Ft(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function zt(t,e){return!e||"object"!==Ut(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function Ht(t){return(Ht=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function Xt(t,e){return(Xt=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var Gt=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Nt(this,e),zt(this,Ht(e).call(this,It({},t,{name:"WalkMovable",interface:"Movable"})))}var n,i,r;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&Xt(t,e)}(e,t),n=e,(i=[{key:"TryMove",value:function(t,e){var n=this.entity.map,i=n.GetTile(t,e),r=n.GetEntityAt(t,e);return r?!!this.entity.HasComponent("Attacker")&&(this.entity.components.Attacker.Attack(r),!0):i.IsWalkable?(this.entity.position={x:t,y:e},!0):!!i.IsDiggable&&(n.Dig(t,e),!0)}}])&&Ft(n.prototype,i),r&&Ft(n,r),e}(Pt);function Bt(t){return(Bt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function Yt(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function qt(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?Yt(Object(n),!0).forEach((function(e){$t(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Yt(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function $t(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function Jt(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function Qt(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function Zt(t,e){return!e||"object"!==Bt(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function te(t){return(te=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function ee(t,e){return(ee=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var ne=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Jt(this,e),Zt(this,te(e).call(this,qt({},t,{name:"PlayerActor",interface:"Actor"})))}var n,i,r;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&ee(t,e)}(e,t),n=e,(i=[{key:"act",value:function(){var t=this.entity.game;t.Render(),t.LockCurrentEngine(),this.entity.HasComponent("EventListener")&&this.entity.components.EventListener.Clear()}}])&&Qt(n.prototype,i),r&&Qt(n,r),e}(Pt);function ie(t){return(ie="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function re(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function oe(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?re(Object(n),!0).forEach((function(e){se(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):re(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function se(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function ae(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function le(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function ce(t,e){return!e||"object"!==ie(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function he(t){return(he=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function ue(t,e){return(ue=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var fe=function(t){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return ae(this,e),(t=ce(this,he(e).call(this,oe({},n,{name:"FungusActor",interface:"Actor"})))).growthsRemaining=n.growths||10,t.growChance=n.growChance=.25,t}var n,i,r;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&ue(t,e)}(e,t),n=e,(i=[{key:"act",value:function(){if(this.growthsRemaining>0&&Math.random()<=this.growChance){--this.growthsRemaining;var t=this.entity.x+Math.floor(3*Math.random())-1,e=this.entity.y+Math.floor(3*Math.random())-1;if(this.entity.map.IsWalkable(t,e)){var n=un(this.entity.game,"Fungus",t,e);n.components.FungusActor.growthsRemaining=this.growthsRemaining/2,this.growthsRemaining=this.growthsRemaining/2,this.entity.map.AddEntity(n),this.entity.game.PostEventToNearbyEntities(this.entity.map,this.entity.x,this.entity.y,"The ".concat(this.entity.name," is spreading!"))}}}}])&&le(n.prototype,i),r&&le(n,r),e}(Pt);function pe(t){return(pe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _e(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function ge(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?_e(Object(n),!0).forEach((function(e){de(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):_e(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function de(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function ye(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function me(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function be(t,e){return!e||"object"!==pe(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function ve(t){return(ve=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function we(t,e){return(we=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var Oe=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return ye(this,e),be(this,ve(e).call(this,ge({},t,{name:"WanderActor",interface:"Actor"})))}var n,i,r;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&we(t,e)}(e,t),n=e,(i=[{key:"act",value:function(){var t=Math.floor(3*Math.random()-1),e=Math.floor(3*Math.random()-1);this.entity.components.Movable.TryMove(this.entity.x+t,this.entity.y+e)}}])&&me(n.prototype,i),r&&me(n,r),e}(Pt);function Pe(t){return(Pe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function ke(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function Ee(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ke(Object(n),!0).forEach((function(e){Se(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ke(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function Se(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function Te(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function xe(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function je(t,e){return!e||"object"!==Pe(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function Ce(t){return(Ce=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function Me(t,e){return(Me=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var Re=function(t){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Te(this,e),(t=je(this,Ce(e).call(this,Ee({},n,{name:"Destructible",interface:"Destructible"})))).maxHp=n.maxHp||10,t.hp=n.hp||t.maxHp,t.defense=n.defense||0,t}var n,i,r;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&Me(t,e)}(e,t),n=e,(i=[{key:"TakeDamage",value:function(t,e){this.hp-=e,this.hp<=0&&(this.entity.map.RemoveEntity(this.entity),this.entity.game.PostEvent(this.entity,"You die!"),this.entity.game.PostEvent(t.entity,"You kill the ".concat(this.entity.name,"!")))}}])&&xe(n.prototype,i),r&&xe(n,r),e}(Pt);function Ae(t){return(Ae="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function Ke(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function Ve(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?Ke(Object(n),!0).forEach((function(e){De(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Ke(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function De(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function Ue(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function Le(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function Ie(t,e){return!e||"object"!==Ae(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function We(t){return(We=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function Ne(t,e){return(Ne=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var Fe=function(t){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Ue(this,e),(t=Ie(this,We(e).call(this,Ve({},n,{name:"Attacker",interface:"Attacker"})))).attack=n.attack||1,t}var n,i,r;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&Ne(t,e)}(e,t),n=e,(i=[{key:"Attack",value:function(t){if(t.HasComponent("Destructible")){var e=t.components.Destructible.defense,n=Math.max(0,this.attack-e),i=1+Math.floor(Math.random()*n);this.entity.game.PostEvent(this.entity,"You strike the ".concat(t.name," for ").concat(i," damage!")),this.entity.game.PostEvent(t,"The ".concat(this.entity.name," strikes you for ").concat(i," damage!")),t.components.Destructible.TakeDamage(this,i)}}}])&&Le(n.prototype,i),r&&Le(n,r),e}(Pt);function ze(t){return(ze="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function He(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function Xe(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?He(Object(n),!0).forEach((function(e){Ge(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):He(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function Ge(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function Be(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function Ye(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function qe(t,e){return!e||"object"!==ze(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function $e(t){return($e=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function Je(t,e){return(Je=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var Qe=function(t){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Be(this,e),(t=qe(this,$e(e).call(this,Xe({},n,{name:"EventListener",interface:"EventListener"})))).events=[],t}var n,i,r;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&Je(t,e)}(e,t),n=e,(i=[{key:"Post",value:function(t){this.events.push(t)}},{key:"Clear",value:function(){this.events=[]}}])&&Ye(n.prototype,i),r&&Ye(n,r),e}(Pt);function Ze(t){return(Ze="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function tn(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function en(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?tn(Object(n),!0).forEach((function(e){nn(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):tn(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function nn(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function rn(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function on(t,e){return!e||"object"!==Ze(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function sn(t){return(sn=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function an(t,e){return(an=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var ln=function(t){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return rn(this,e),(t=on(this,sn(e).call(this,en({},n,{name:"Sight",interface:"Sight"})))).radius=n.radius||5,t}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&an(t,e)}(e,t),e}(Pt);function cn(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function hn(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function un(t,e,n,i){"string"==typeof e&&(e=Dt[e]);var o=[];return e.components.forEach((function(t){"string"==typeof t&&(t={name:t}),o.push(new r[t.name](t))})),e.components=o,new Vt(t,function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?cn(Object(n),!0).forEach((function(e){hn(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):cn(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}({},e,{x:n,y:i}))}function fn(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var pn=function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};fn(this,t),this.glyph=new Rt(e),Object.assign(this,this.glyph);var n=e.IsWalkable;this.IsWalkable=void 0!==n&&n;var i=e.IsDiggable;this.IsDiggable=void 0!==i&&i;var r=e.BlocksLight;this.BlocksLight=void 0!==r&&r,this.seen=!1};function _n(){return window.objectPool.nullTile||(window.objectPool.nullTile=new pn),window.objectPool.nullTile}function gn(){return window.objectPool.wallTile||(window.objectPool.wallTile=new pn({character:"#",foreground:"saddlebrown",IsDiggable:!0,BlocksLight:!0})),window.objectPool.wallTile}function dn(){return window.objectPool.floorTile||(window.objectPool.floorTile=new pn({character:"·",foreground:"slategray",IsWalkable:!0})),window.objectPool.floorTile}function yn(){return window.objectPool.upStairTile||(window.objectPool.upStairTile=new pn({character:"<",foreground:"white",IsWalkable:!0})),window.objectPool.upStairTile}function mn(){return window.objectPool.downStairTile||(window.objectPool.downStairTile=new pn({character:">",foreground:"white",IsWalkable:!0})),window.objectPool.downStairTile}function bn(t){for(var e=t.length-1;e>0;e--){var n=Math.floor(Math.random()*(e+1)),i=[t[n],t[e]];t[e]=i[0],t[n]=i[1]}return t}function vn(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var wn=function(t,e){return"".concat(t,",").concat(e)},On=function(){function t(e,n){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.tiles=n,this.width=n.length,this.height=n[0].length,this.game=e,this.seen={},this.entities={},this.scheduler=new D.Simple,this.engine=new q(this.scheduler);var i=this;this.fov=new I.DiscreteShadowcasting((function(t,e){return!i.GetTile(t,e).BlocksLight}));for(var r=["Bat","Newt","Fungus"],o=0;o<100;o++){var s=r[Math.floor(3*Math.random())],a=un(this.game,s,0,0);this.AddEntityAtRandomPosition(a)}}var e,n,i;return e=t,(n=[{key:"AddEntity",value:function(t){t.SetMap(this),this.UpdateEntityPosition(t),t.HasComponent("Actor")&&this.scheduler.add(t,!0)}},{key:"RemoveEntity",value:function(t){delete this.entities[wn(t.x,t.y)],t.HasComponent("Actor")&&this.scheduler.remove(t)}},{key:"AddEntityAtRandomPosition",value:function(t){var e=this.GetRandomWalkablePosition();t.x=e.x,t.y=e.y,this.AddEntity(t)}},{key:"UpdateEntityPosition",value:function(t,e,n){if(this.entities[wn(e,n)]===t&&delete this.entities[wn(e,n)],t.x<0||t.x>this.width||t.y<0||t.y>this.height)throw new Error("Attempted to add enitity out of bounds: ",t);if(this.entities[wn(t.x,t.y)])throw new Error("Attempting to add entity to occupied space",t);this.entities[wn(t.x,t.y)]=t}},{key:"GetEntityAt",value:function(t,e){return this.entities[wn(t,e)]}},{key:"GetTile",value:function(t,e){return t<0||t>=this.width||e<0||e>=this.length?_n():this.tiles[t][e]||_n()}},{key:"GetEntitiesWithinRadius",value:function(t,e,n){var i=[];for(var r in this.entities){var o=this.entities[r],s=t-n,a=t+n,l=e-n,c=e+n;o.x>=s&&o.x<=a&&o.y>=l&&o.y<=c&&i.push(o)}return i}},{key:"GetNeighborTiles",value:function(t,e){for(var n=[],i=-1;i<2;i++)for(var r=-1;r<2;r++)0==i&&0==r||n.push({x:t+i,y:e+r});return bn(n)}},{key:"Dig",value:function(t,e){this.GetTile(t,e).IsDiggable&&(this.tiles[t][e]=dn())}},{key:"IsWalkable",value:function(t,e){return this.GetTile(t,e).IsWalkable&&!this.GetEntityAt(t,e)}},{key:"GetRandomWalkablePosition",value:function(){var t,e,n=0;do{if(t=Math.floor(Math.random()*this.width),e=Math.floor(Math.random()*this.height),n++>1e4)throw new Error("Couldn't find walkable position in map"+this)}while(!this.IsWalkable(t,e));return{x:t,y:e}}}])&&vn(e.prototype,n),i&&vn(e,i),t}();function Pn(t,e,n){var i=J.c.cave,r=function(t,e){for(var n=[],i=0;i<t;i++){n.push([]);for(var r=0;r<e;r++)n[i].push(_n())}return n}(e,n),o=new Y.Cellular(e,n);o.randomize(i.fill);for(var s=0;s<i.iterations-1;++s)o.create();return o.create((function(t,e,n){r[t][e]=1===n?dn():gn()})),new On(t,r)}function kn(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var En=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.config=J.b,this.maps=[],this.regions=[]}var e,n,i;return e=t,(n=[{key:"GetTile",value:function(t,e,n){return this.maps[n].GetTile(t,e)}},{key:"Generate",value:function(t){var e=this,n=0;this.config.levels.forEach((function(i){var r=new o[i](t,e.config.width,e.config.height);e.maps.push(r),e.regions[n]=new Array(r.width);for(var s=0;s<r.width;++s){e.regions[n][s]=new Array(r.height);for(var a=0;a<r.height;++a)e.regions[n][s][a]=0}++n}));for(var i=0;i<this.config.levels.length;++i)this.SetupRegions(i);return this.ConnectAllRegions(),this.maps}},{key:"CanFillRegion",value:function(t,e,n){var i=this.config,r=i.width,o=i.height,s=this.config.levels.length;return!(t<0||e<0||n<0||t>=r||e>=o||n>=s)&&0===this.regions[n][t][e]&&this.GetTile(t,e,n).IsWalkable}},{key:"FillRegion",value:function(t,e,n,i){var r,o,s=1,a=[{x:e,y:n}];for(this.regions[i][e][n]=t;a.length;)for(r=a.pop(),o=this.maps[i].GetNeighborTiles(r.x,r.y);o.length;)r=o.pop(),this.CanFillRegion(r.x,r.y,i)&&(this.regions[i][r.x][r.y]=t,a.push(r),++s);return s}},{key:"RemoveRegion",value:function(t,e){for(var n=0;n<this.config.width;++n)for(var i=0;i<this.config.height;++i)this.regions[e][n][i]===t&&(this.regions[e][n][i]=0,this.maps[e].tiles[n][i]=gn())}},{key:"SetupRegions",value:function(t){for(var e=1,n=0;n<this.config.width;++n)for(var i=0;i<this.config.height;++i)this.CanFillRegion(n,i,t)&&(this.FillRegion(e,n,i,t)<20?this.RemoveRegion(e,t):++e)}},{key:"FindRegionOverlaps",value:function(t,e,n){for(var i=[],r=0;r<this.config.width;++r)for(var o=0;o<this.config.height;++o)this.GetTile(r,o,t)===dn()&&this.GetTile(r,o,t+1)===dn()&&this.regions[t][r][o]===e&&this.regions[t+1][r][o]===n&&i.push({x:r,y:o});return bn(i)}},{key:"ConnectRegions",value:function(t,e,n){var i=this.FindRegionOverlaps(t,e,n);if(!i.length)return!1;var r=i[0];return this.maps[t].tiles[r.x][r.y]=mn(),this.maps[t+1].tiles[r.x][r.y]=yn(),!0}},{key:"ConnectAllRegions",value:function(){for(var t=0;t<this.config.levels.length-1;++t)for(var e={},n=void 0,i=0;i<this.config.width;++i)for(var r=0;r<this.config.height;++r)n=this.regions[t][i][r]+","+this.regions[t+1][i][r],this.GetTile(i,r,t)!==dn()||this.GetTile(i,r,t+1)!==dn()||e[n]||(this.ConnectRegions(t,this.regions[t][i][r],this.regions[t+1][i][r]),e[n]=!0)}}])&&kn(e.prototype,n),i&&kn(e,i),t}();function Sn(t){return(Sn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function Tn(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function xn(t,e){return!e||"object"!==Sn(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function jn(t,e,n){return(jn="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,n){var i=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=Cn(t)););return t}(t,e);if(i){var r=Object.getOwnPropertyDescriptor(i,e);return r.get?r.get.call(n):r.value}})(t,e,n||t)}function Cn(t){return(Cn=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function Mn(t,e){return(Mn=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var Rn=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Math.max(n,Math.min(e,t))},An={Splash:st,Victory:pt,GameOver:vt,Play:function(t){function e(t){var n;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),(n=xn(this,Cn(e).call(this,t))).screenName="Play screen",n.currentLevel=0,n.player=null,n.dungeon=null,n}var n,i,r;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&Mn(t,e)}(e,t),n=e,(i=[{key:"Ascend",value:function(){return this.currentLevel<=0?(this.player.components.EventListener.Post("You cannot go higher. This is the first floor of the dungeon."),!1):this.map.GetTile(this.player.x,this.player.y)!==yn()?(this.player.components.EventListener.Post("There are no stairs leading up here."),!1):(this.map.RemoveEntity(this.player),--this.currentLevel,this.map.AddEntity(this.player),!0)}},{key:"Descend",value:function(){return this.currentLevel>=this.dungeon.length-1?(this.player.components.EventListener.Post("You cannot go deeper."),!1):this.map.GetTile(this.player.x,this.player.y)!==mn()?(this.player.components.EventListener.Post("There are no stairs leading down here."),!1):(this.map.RemoveEntity(this.player),++this.currentLevel,this.map.AddEntity(this.player),!0)}},{key:"Enter",value:function(){jn(Cn(e.prototype),"Enter",this).call(this),this.player=un(this.game,"Player",0,0),this.dungeon=new En(this.game).Generate(this.game),this.map.AddEntityAtRandomPosition(this.player)}},{key:"Exit",value:function(){jn(Cn(e.prototype),"Exit",this).call(this)}},{key:"Render",value:function(t){console.log("Render");var e=J.a.playArea,n=Rn(this.player.x-e.width/2,this.map.width-e.width,0),i=Rn(this.player.y-e.height/2,this.map.height-e.height,0),r={};this.map.fov.compute(this.player.x,this.player.y,this.player.components.Sight.radius,(function(t,e,n,i){r["".concat(t,",").concat(e)]=!0}));for(var o=n;o<n+e.width;++o)for(var s=i;s<i+e.height;++s){var a=!!r["".concat(o,",").concat(s)],l=!!this.map.seen["".concat(o,",").concat(s)];if(a||l){var c=this.map.GetTile(o,s),h=c.character,u=c.foreground,f=c.background;a||(u="darkslategray"),this.map.seen["".concat(o,",").concat(s)]=!0,t.draw(o-n,s-i,h,u,f)}}for(var p in this.map.entities){var _=this.map.entities[p];if(_.x>=n&&_.x<n+e.width&&_.y>=i&&_.y<i+e.height){if(!r["".concat(_.x,",").concat(_.y)])continue;t.draw(_.x-n,_.y-i,_.components.Glyph.character,_.components.Glyph.foreground,_.components.Glyph.background)}}var g={x:0,y:e.height},d=this.player.components.Destructible,y=d.hp,m=d.maxHp,b=y>m/2?"%c{green}%b{black}":"%c{red}%b{black}";g.y+=t.drawText(g.x,g.y,"Hp: ".concat(b+y,"%c{white}%b{black}/").concat(m)),this.player.components.EventListener.events.forEach((function(e){g.y+=t.drawText(g.x,g.y,e,J.a.rotConfig.width)}))}},{key:"Move",value:function(t,e){var n=this.player.x+t,i=this.player.y+e;return this.player.components.Movable.TryMove(n,i,this.map)}},{key:"HandleInput",value:function(t,e){var n=C,i=!1,r=!1;if("keyup"===t&&(e.keyCode,r=!0),"keypress"===t)switch(String.fromCharCode(e.charCode)){case">":i=this.Descend();break;case"<":i=this.Ascend();break;default:r=!0}if("keydown"===t)switch(e.keyCode){case n.VK_RETURN:this.game.Transition("victory");break;case n.VK_ESCAPE:this.game.Transition("gameover");break;case n.VK_NUMPAD4:case n.VK_LEFT:i=this.Move(-1,0);break;case n.VK_NUMPAD6:case n.VK_RIGHT:i=this.Move(1,0);break;case n.VK_NUMPAD8:case n.VK_UP:i=this.Move(0,-1);break;case n.VK_NUMPAD2:case n.VK_DOWN:i=this.Move(0,1);break;case n.VK_NUMPAD7:i=this.Move(-1,-1);break;case n.VK_NUMPAD1:i=this.Move(-1,1);break;case n.VK_NUMPAD3:i=this.Move(1,1);break;case n.VK_NUMPAD9:i=this.Move(1,-1);break;default:r=!0}i?this.game.UnlockCurrentEngine():r||this.game.Render()}},{key:"map",get:function(){return this.dungeon[this.currentLevel]}}])&&Tn(n.prototype,i),r&&Tn(n,r),e}(Z)};function Kn(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var Vn=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.currentScreen=null;var e={game:this};this.screens={splash:new An.Splash(e),play:new An.Play(e),gameover:new An.GameOver(e),victory:new An.Victory(e)}}var e,n,i;return e=t,(n=[{key:"Init",value:function(){this.display=new A(J.a.rotConfig),document.body.appendChild(this.display.getContainer());var t=this,e=function(e){window.addEventListener(e,(function(n){t.currentScreen&&t.currentScreen.HandleInput(e,n)}))};e("keydown"),e("keyup"),e("keypress"),this.Transition("splash")}},{key:"PostEventToNearbyEntities",value:function(t,e,n,i){var r=this,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:5;t.GetEntitiesWithinRadius(e,n,o).forEach((function(t){return r.PostEvent(t,i)}))}},{key:"PostEvent",value:function(t,e){t.HasComponent("EventListener")&&t.components.EventListener.Post(e)}},{key:"Render",value:function(){this.display.clear(),this.currentScreen.Render(this.display)}},{key:"LockCurrentEngine",value:function(){try{return this.currentScreen.map.engine.lock(),!0}catch(t){return console.log("Tried to lock engine but failed: "+t),!1}}},{key:"UnlockCurrentEngine",value:function(){try{return this.currentScreen.map.engine.unlock(),!0}catch(t){return console.log("Tried to unlock engine but failed: "+t),!1}}},{key:"SwitchScreen",value:function(t){this.currentScreen&&this.currentScreen.Exit(),this.currentScreen=t,this.currentScreen&&(this.currentScreen.Enter(),this.Render())}},{key:"Transition",value:function(t){this.SwitchScreen(this.screens[t])}}])&&Kn(e.prototype,n),i&&Kn(e,i),t}();document.addEventListener("DOMContentLoaded",(function(){window.objectPool={},(new Vn).Init()}))}]);